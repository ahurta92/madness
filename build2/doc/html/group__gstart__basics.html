<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MADNESS: MADNESS basics</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MADNESS
   &#160;<span id="projectnumber">0.10.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">MADNESS basics<div class="ingroups"><a class="el" href="group__getting__started.html">Getting started with MADNESS</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<div class="dynheader">
Collaboration diagram for MADNESS basics:</div>
<div class="dyncontent">
<center><table><tr><td><img src="group__gstart__basics.png" border="0" alt="" usemap="#group____gstart____basics"/>
<map name="group____gstart____basics" id="group____gstart____basics">
<area shape="rect" id="node2" href="group__getting__started.html" title="Getting started with\l MADNESS" alt="" coords="6,5,138,45"/>
</map>
</td></tr></table></center>
</div>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000004">Todo:</a></b></dt><dd>Verify that the code snippets here aren't stale. They're imported from a 2010 document.</dd></dl>
<p class="">Documentation and instructions exist in several places:</p><ul>
<li>the <a href="http://www.doxygen.org/"><code>doxygen</code></a> generated documentation (see also the <code>doc</code> directory), and</li>
<li>the <a href="https://github.com/m-a-d-n-e-s-s/madness">project wiki</a>.</li>
</ul>
<p>For basic computing with MADNESS functions, the only header file that you should need to include is <code>&lt;mra/mra.h&gt;</code>. Advanced programs may need a few others. You should include the directory in the include path to avoid possible conflicts with similarly named files from other packages. In the following documentation <code>trunk</code> will denote the top-level directory of the MADNESS distribution. </p><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000005">Todo:</a></b></dt><dd>Is it <code>mra.h</code> or should we be using <code>madness.h</code>?</dd></dl>
<dl class="section user"><dt>From math to C++ to numerical computation</dt><dd></dd></dl>
<p>This section shows you how to use MADNESS and evaluate a simple mathematical expression, notably this one dimensional integral. </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ \int_{0}^{10} \sin (x) \mathit{dx} = 1 - \cos(10) \doteq 1.8390715 \]" src="form_0.png"/>
</p>
<p> The corresponding code is in <code>trunk/src/examples/sininteg.cc</code>, and we will go through this first example in gory detail. The main steps will be</p><ol type="1">
<li>translating the function from math to <a class="el" href="classC.html">C</a>++ to be called by MADNESS</li>
<li>initializing the MADNESS parallel runtime</li>
<li>initializing the MADNESS numerical environment</li>
<li>generating a numerical representation from the <a class="el" href="classC.html">C</a>++ function</li>
<li>computing the integral</li>
<li>printing the result</li>
<li>terminating the MADNESS parallel runtime</li>
<li>compiling your program</li>
<li>running your program</li>
</ol>
<dl class="section user"><dt>Step 1 &ndash; translating from Math to C++</dt><dd></dd></dl>
<p>MADNESS generates a numerical representation of a function ( <img class="formulaInl" alt="$ f(x) $" src="form_1.png"/>) by projecting into its internal, orthonormal basis, <img class="formulaInl" alt="$\{\phi _{li}^{n}(x)\}$" src="form_2.png"/>, see <a class="el" href="group__mra.html">Mra</a> for more detail. This involves computing many integrals of the form </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ s_{li}^{n} = \int \phi _{li}^{n}(x) f(x) \mathit{dx} \]" src="form_3.png"/>
</p>
<p> using adaptive numerical quadrature. Thus, MADNESS has to be able to evaluate your function at an arbitrary point, and so you must provide it with a <a class="el" href="classC.html">C</a>++ implementation of your function using a standard interface. MADNESS passes to your function the coordinates (an array of the appropriate dimension) and you return the value. For simple functions, a <a class="el" href="classC.html">C</a>++ function suffices whereas more complicated stuff might require a <a class="el" href="classC.html">C</a>++ class (see a subsequent example).</p>
<p class="">For this example, we wish to evaluate the function <img class="formulaInl" alt="$\sin(x)$" src="form_4.png"/> where <img class="formulaInl" alt="$x$" src="form_5.png"/> is a 1-<a class="el" href="structD.html">D</a> coordinate. The example code looks like </p><div class="fragment"><div class="line"><span class="keywordtype">double</span> <a class="code" href="ploterr_8cc.html#a1f6ba78c14bc08356189d857426d2553">myf</a>(<span class="keyword">const</span> <a class="code" href="namespacemadness.html#a3c9859e55f5e6d683f0ed713418aa30c">coord_1d</a>&amp; r) {</div><div class="line">  <span class="keywordflow">return</span> std::sin(r[0]);</div><div class="line">}</div></div><!-- fragment --><p> If your function were in 3-<a class="el" href="structD.html">D</a> it would be passed a <code>coord_3d</code> that would have 3 elements (0, 1, and 2) that you might interpret as <img class="formulaInl" alt="$(x, y, z)$" src="form_6.png"/> or <img class="formulaInl" alt="$(r, \theta, \phi)$" src="form_7.png"/> or something else as defined by your problem. <a class="el" href="classA.html">A</a> very useful capability of both Maple and Mathematica is to generate <a class="el" href="classC.html">C</a> from expressions or functions, though the resulting code often requires a little cleanup.</p>
<dl class="section attention"><dt>Attention</dt><dd><ul>
<li>If your function contains discontinuities (in value or derivatives), noise, or singularities, special care is needed. This is discussed in more detail below, but the simple rule of thumb is your function should be accurate nearly to machine precision even if you only want to compute to much lower precision with MADNESS.</li>
<li>MADNESS will call your function from multiple threads in order to use multi-core processors efficiently, so the code for your function should be thread safe. It should not modify static (Fortran keyword <code>save</code>) or global (Fortran common blocks or modules) data; reading from such locations is fine. Note that this constraint applies to all code invoked by your function, including math, BLAS, and linear algebra libraries and for some machines/compilers it requires special options be used (the MADNESS makefiles look after this). If you suspect a thread problem, try running with the environment variable <code>MAD_NUM_THREADS</code> set to one.</li>
<li>If you are using the AMD math library ACML, do not set the environmental variable <code>OMP_NUM_THREADS</code> (or set it to one).</li>
</ul>
</dd></dl>
<dl class="section user"><dt>Steps 2, 3 and 7 &ndash; initializing and finalizing the MADNESS environment</dt><dd></dd></dl>
<p>MADNESS has its own parallel runtime environment that is fully compatible with the Message Passing Interface (MPI). Just as for MPI, the MADNESS runtime must be initialized at the start and cleaned up at the end. Here is the simplest parallel program using MADNESS. </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mra_8h.html">madness/mra/mra.h</a>&gt;</span></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacemadness.html">madness</a>;</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="plotxc_8cc.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv) {</div><div class="line">    <a class="code" href="namespacemadness.html#a8a4791551025b3f1015f8d8648ad6991">initialize</a>(argc, argv);</div><div class="line">    <a class="code" href="classmadness_1_1World.html">World</a> world(<a class="code" href="namespaceSafeMPI.html#a0365d74d2b7bbe9d2d05dca25e4449f6">SafeMPI::COMM_WORLD</a>);</div><div class="line">    <a class="code" href="namespacemadness.html#a5a12141a8c6ddfa9dc8e5bd9717ddfa3">startup</a>(world, argc, argv);</div><div class="line">  </div><div class="line">    <span class="comment">// Do something useful here!</span></div><div class="line">    </div><div class="line">    <a class="code" href="namespacemadness.html#a326cf304974224597661e46246240263">finalize</a>();</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p> The <code>World</code> object in MADNESS is similar to an MPI communicator (each <code>World</code> is associated with a communicator) but contains all of the information necessary to provide the rich functionality of the MADNESS runtime. Instead of calling <code>MPI::Init()</code> and <code>MPI::Finalize()</code>, a MADNESS program invokes <code><a class="el" href="namespacemadness.html#a8a4791551025b3f1015f8d8648ad6991" title="Initialize the MADNESS runtime. ">madness::initialize()</a></code> and <code><a class="el" href="namespacemadness.html#a326cf304974224597661e46246240263" title="Call this once at the very end of your main program instead of MPI_Finalize(). ">madness::finalize()</a></code> (call <code><a class="el" href="namespacemadness.html#a8621cd6ae91a714c06639942d3910342" title="Check if the MADNESS runtime has been initialized (and not subsequently finalized). ">madness::initialized()</a></code> to check that MADNESS had been initialized). The routine <code><a class="el" href="namespacemadness.html#a5a12141a8c6ddfa9dc8e5bd9717ddfa3">madness::startup()</a></code> initializes the MADNESS numerical environment.</p>
<dl class="section user"><dt>Step 4 &ndash; generating a numerical representation</dt><dd></dd></dl>
<p>We implemented the <a class="el" href="classC.html">C</a>++ function above (<code>myf</code>) and the domain is specified by the problem as <img class="formulaInl" alt="$x\in [0,10]$" src="form_8.png"/>. Presently, all functions of a given dimension being used by a program are assumed to have the same, default domain. We will use the default precision (1e-6 in the L2-norm &ndash; most errors in MADNESS use this norm). </p><div class="fragment"><div class="line">FunctionDefaults&lt;1&gt;::set_cubic_cell(0, 10);</div><div class="line"></div><div class="line"><a class="code" href="namespacemadness.html#a990e53e435f5de020260224ecd4a79fc">real_function_1d</a> <a class="code" href="derivatives_8cc.html#a077a479820cb59b18ba5f9565d735e0f">f</a> = <a class="code" href="namespacemadness.html#a8f559457e76e22ca919acb68d33b3872">real_factory_1d</a>(world).f(<a class="code" href="ploterr_8cc.html#a1f6ba78c14bc08356189d857426d2553">myf</a>);</div></div><!-- fragment --><p> The first line sets the domain and the second makes a numerical representation of your function. The slightly unusual form of the constructor for a MADNESS function is called the "named parameter idiom." The first version of MADNESS was written in Python, which provides named parameters that can have default values. To override the default for some parameter only required specifying its name. However, <a class="el" href="classC.html">C</a>++ does not provide named parameters and the closest we can get to them is the above idiom. To make a <code>Function</code> what you are actually doing is making a <code>FunctionFactory</code> associated with a <code>World</code>, overriding defaults inside the factory, and then constructing a function from the factory. The default function is zero, so to make a zero 1<a class="el" href="structD.html">D</a> function we would just type </p><div class="fragment"><div class="line"><a class="code" href="namespacemadness.html#a990e53e435f5de020260224ecd4a79fc">real_function_1d</a> zero = <a class="code" href="namespacemadness.html#a8f559457e76e22ca919acb68d33b3872">real_factory_1d</a>(world);</div></div><!-- fragment --><p class="">In the second line, to generate a MADNESS <code>Function</code> from your <a class="el" href="classC.html">C</a>++ function we override the default with the desired function pointer.</p>
<dl class="section user"><dt>Step 5 &ndash; computing the integral</dt><dd></dd></dl>
<p>The integral of a function over the whole domain is computed with the <code>trace()</code> function, c.f., </p><div class="fragment"><div class="line"><span class="keywordtype">double</span> integral = <a class="code" href="derivatives_8cc.html#a077a479820cb59b18ba5f9565d735e0f">f</a>.trace();</div></div><!-- fragment --><dl class="section attention"><dt>Attention</dt><dd>This is a collective parallel operation. If you are running in parallel, the numerical representation of your function is distributed across multiple processors, so adding up the result requires collective communication (the equivalent of MPI's <code>All_reduce()</code>). Therefore, every process associated with the <code>World</code> must execute this statement; otherwise your program will hang if it is running in parallel using MPI.</dd></dl>
<dl class="section user"><dt>Step 6 &ndash; printing the result</dt><dd></dd></dl>
<p>If you only want to run sequentially, just print your data in any of the myriad ways possible using <a class="el" href="classC.html">C</a>++. However, if you ever want to run in parallel across multiple nodes using MPI you should from the outset get in the habit of writing the following instead </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> (world.rank() == 0) <a class="code" href="mcpfit_8cc.html#ad5c820bf5b88d465aa91f87591658f03">print</a>(<span class="stringliteral">&quot;The result is &quot;</span>, integral);</div></div><!-- fragment --><p> The critical ingredient is the if-test that ensures only one process actually does the printing (in this case process zero, but that choice is arbitrary). If you don't do this, your output will be unexpectedly verbose. The templated routine <code><a class="el" href="mcpfit_8cc.html#ad5c820bf5b88d465aa91f87591658f03">print()</a></code> is just a convenience wrapper around <code>cout &lt;&lt;</code> that automatically inserts spaces between elements and a newline at the end.</p>
<dl class="section attention"><dt>Attention</dt><dd>We assigned the result of <code>f.trace()</code> to a variable because <code>trace</code> is a collective, but printing is serial. Anecdotally, at least 90% of hanging parallel programs are due to getting this wrong.</dd></dl>
<dl class="section user"><dt>The complete program</dt><dd></dd></dl>
<p>Your complete program, <code>trunk/src/apps/sininteg.cc</code>, looks like this </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mra_8h.html">madness/mra/mra.h</a>&gt;</span></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacemadness.html">madness</a>;</div><div class="line"></div><div class="line"><span class="keywordtype">double</span> <a class="code" href="ploterr_8cc.html#a1f6ba78c14bc08356189d857426d2553">myf</a>(<span class="keyword">const</span> <a class="code" href="classmadness_1_1Vector.html">coord_1d</a>&amp; r) {</div><div class="line">    <span class="keywordflow">return</span> std::sin(r[0]);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="plotxc_8cc.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv) {</div><div class="line">    <a class="code" href="namespacemadness.html#a8a4791551025b3f1015f8d8648ad6991">initialize</a>(argc, argv);</div><div class="line">    <a class="code" href="classmadness_1_1World.html">World</a> world(<a class="code" href="namespaceSafeMPI.html#a0365d74d2b7bbe9d2d05dca25e4449f6">SafeMPI::COMM_WORLD</a>);</div><div class="line">    <a class="code" href="namespacemadness.html#a5a12141a8c6ddfa9dc8e5bd9717ddfa3">startup</a>(world,argc,argv);</div><div class="line">    <a class="code" href="classmadness_1_1FunctionDefaults.html#a9ba324ffb65d8d764bba358251745f7b">FunctionDefaults&lt;1&gt;::set_cubic_cell</a>(0,10);</div><div class="line">    </div><div class="line">    <a class="code" href="classmadness_1_1Function.html">real_function_1d</a> <a class="code" href="namespacemadness.html#a9ce6d524200a2dee9baf7f4e308b8b40">f</a> = <a class="code" href="namespacemadness.html#a8f559457e76e22ca919acb68d33b3872">real_factory_1d</a>(world).f(<a class="code" href="ploterr_8cc.html#a1f6ba78c14bc08356189d857426d2553">myf</a>);</div><div class="line">    </div><div class="line">    doub  le integral = <a class="code" href="namespacemadness.html#a9ce6d524200a2dee9baf7f4e308b8b40">f</a>.trace();</div><div class="line">    </div><div class="line">    <span class="keywordflow">if</span> (world.rank() == 0) <a class="code" href="group__libraries.html#ga925cbfa806133b64f5cee7a7d810efeb">print</a>(<span class="stringliteral">&quot;The result is&quot;</span>, integral);</div><div class="line"></div><div class="line">    <a class="code" href="namespacemadness.html#a326cf304974224597661e46246240263">finalize</a>();</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p> Yes, this is rather verbose for integrating <img class="formulaInl" alt="$\sin(x)$" src="form_4.png"/> in 1<a class="el" href="structD.html">D</a>, but you should already be able to see that most of it is boiler plate. You could be integrating a much more complicated function in 4-<a class="el" href="structD.html">D</a> with only little more personal effort (the computer might have to work a lot harder though).</p>
<p class="">Previous: <a class="el" href="group__getting__started.html">Getting started with MADNESS</a>; Next: <a class="el" href="group__gstart__comp__run.html">Compiling and running MADNESS programs</a> </p>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Feb 6 2020 16:37:43 for MADNESS by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
